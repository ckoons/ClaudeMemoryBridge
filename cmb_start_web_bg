#!/bin/bash
# Start all Claude Memory Bridge services including the web UI in the background

# Find the directory where this script is located
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
cd "$SCRIPT_DIR"

# Parse command line arguments
HOST="127.0.0.1"
PORT=8002
DEBUG=false

while [[ $# -gt 0 ]]; do
  case $1 in
    --host)
      HOST="$2"
      shift 2
      ;;
    --port)
      PORT="$2"
      shift 2
      ;;
    --debug)
      DEBUG=true
      shift
      ;;
    --help)
      echo "Usage: ./cmb_start_web_bg [options]"
      echo ""
      echo "Options:"
      echo "  --host HOST      Host to bind the web UI to (default: 127.0.0.1)"
      echo "  --port PORT      Port for the web UI (default: 8002)"
      echo "  --debug          Run the web UI in debug mode"
      echo "  --help           Show this help message"
      exit 0
      ;;
    *)
      echo "Unknown option: $1"
      echo "Use --help for usage information"
      exit 1
      ;;
  esac
done

echo "Starting Claude Memory Bridge with Web UI (all in background)..."
echo ""
echo "1. Starting memory service..."
nohup ./cmb > cmb.log 2>&1 &
CMB_PID=$!
echo "   Memory service started (PID: $CMB_PID)"

# Wait a moment for the memory service to initialize
sleep 2

echo "2. Starting HTTP wrapper..."
nohup ./cmb_http > cmb_http.log 2>&1 &
HTTP_PID=$!
echo "   HTTP wrapper started (PID: $HTTP_PID)"

# Wait a moment for the HTTP wrapper to initialize
sleep 2

echo "3. Starting web UI on $HOST:$PORT..."
if [ "$DEBUG" = true ]; then
  echo "   Running in debug mode"
  nohup ./cmb_web --host $HOST --port $PORT --debug > cmb_web.log 2>&1 &
else
  nohup ./cmb_web --host $HOST --port $PORT > cmb_web.log 2>&1 &
fi
WEB_PID=$!
echo "   Web UI started (PID: $WEB_PID)"

# Save PIDs to file for later cleanup
echo "$CMB_PID $HTTP_PID $WEB_PID" > .cmb_pids

echo ""
echo "All services started in background!"
echo "- Memory service: http://127.0.0.1:8000 (PID: $CMB_PID)"
echo "- HTTP wrapper:   http://127.0.0.1:8001 (PID: $HTTP_PID)"
echo "- Web UI:         http://$HOST:$PORT (PID: $WEB_PID)"
echo ""
echo "Access the web interface at: http://$HOST:$PORT"
echo ""
echo "To stop all services, run: ./cmb_stop_web or pkill -f 'cmb|cmb_http|cmb_web'"
echo "To view logs, check: cmb.log, cmb_http.log, and cmb_web.log"
echo ""